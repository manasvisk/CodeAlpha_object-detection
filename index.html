<!DOCTYPE html>
<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
        <title>Realtime Detection UI</title>
        <meta name="description" content="Web UI for real-time video input, sends frames to a detector and overlays results" />
        <style>
            :root{--bg:#0b1220;--card:#071426;--accent:#58d68d;--muted:rgba(255,255,255,0.7)}
            html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;color:#eaf6ff;background:linear-gradient(180deg,#041028,#081426);}
            .wrap{max-width:1200px;margin:18px auto;padding:18px}
            .header{display:flex;align-items:center;justify-content:space-between;gap:12px}
            .brand{font-size:20px;font-weight:600}
            .controls{display:flex;gap:8px;align-items:center}
            .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#eaf6ff;padding:8px 10px;border-radius:8px;cursor:pointer}
            .btn.primary{background:linear-gradient(90deg,#58d68d,#60a5fa);color:#012; border:none}
            .panel{display:flex;gap:14px;margin-top:12px}
            .video-panel{position:relative;background:var(--card);border-radius:12px;overflow:hidden;flex:1;min-height:360px}
            video{width:100%;height:100%;object-fit:cover;display:block}
            canvas{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none}
            .sidebar{width:320px;min-width:260px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:12px;border-radius:12px}
            .field{margin-bottom:10px}
            label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
            input[type=text]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#eaf6ff}
            .muted{color:var(--muted);font-size:13px}
            .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
            .legend span{background:rgba(255,255,255,0.04);padding:6px 8px;border-radius:8px;font-size:13px}
            footer{margin-top:12px;color:var(--muted);font-size:13px}
        </style>


    </style>
</head>
<body>
    <div class="wrap">
        <header>
            <h1>Modern Glass UI Card</h1>
            <span class="tag">UI Demo</span>
        </header>
        <div class="card">
            <div class="left">
                <label for="language">Language</label>
                <div class="row">
                    <select id="language">
                        <option>English</option>
                        <option>Spanish</option>
                        <option>French</option>
                    </select>
                </div>
                <label for="input">Input</label>
                <textarea id="input" placeholder="Type something..."></textarea>
                <div class="controls">
                    <button class="btn btn-primary">Submit</button>
                    <button class="btn">Clear</button>
                </div>
            </div>
            <div class="right">
                <div class="illustration">
                    <svg viewBox="0 0 120 120" fill="none">
                        <circle cx="60" cy="60" r="54" stroke="#7c5cff" stroke-width="4" fill="url(#g1)"/>
                        <defs>
                            <radialGradient id="g1" cx="0.5" cy="0.5" r="0.5">
                                <stop stop-color="#7c5cff" stop-opacity="0.15"/>
                                <stop offset="1" stop-color="#4b9fff" stop-opacity="0"/>
                            </radialGradient>
                        </defs>
                    </svg>
                </div>
                <div class="output" id="output" placeholder="Output will appear here..."></div>
                <div class="actions">
                    <button class="btn">Copy</button>
                    <span class="small">Output actions</span>
                </div>
            </div>
        </div>
        <footer>
            &copy; 2024 &mdash; Demo UI &mdash; <code>index.html</code>
        </footer>
    </div>
</body>
</html>
    </head>
    <body>
        <div class="wrap">
            <div class="header">
                <div>
                    <div class="brand">Realtime Object Detect & Track</div>
                    <div class="muted">Use your webcam — connect to a detection server or run demo mode locally.</div>
                </div>

                <div class="controls">
                    <button id="startBtn" class="btn primary">Start</button>
                    <button id="stopBtn" class="btn">Stop</button>
                </div>
            </div>

            <div class="panel">
                <div class="video-panel" id="videoPanel">
                    <video id="video" autoplay playsinline muted></video>
                    <canvas id="overlay"></canvas>
                </div>

                <aside class="sidebar">
                    <div class="field">
                        <label for="serverUrl">Server WebSocket URL</label>
                        <input id="serverUrl" type="text" value="ws://localhost:8765" />
                    </div>
                    <div class="field">
                        <label>Mode</label>
                        <select id="mode">
                            <option value="ws">WebSocket (push frames)</option>
                            <option value="demo">Demo (no server)</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="sendRate">Send rate (fps)</label>
                        <input id="sendRate" type="text" value="5" />
                        <div class="muted">Lower for less bandwidth; demo mode ignores this.</div>
                    </div>

                    <div class="field">
                        <label>Overlays</label>
                        <div class="muted">Place images in <code>/overlays/{class}.png</code> — names must match class labels from your detector.</div>
                        <div class="legend"><span>person.png</span><span>dog.png</span><span>car.png</span></div>
                    </div>

                    <div class="field">
                        <label>Instructions</label>
                        <div class="muted">Start camera, connect to server. Server must send detection messages with normalized bbox coordinates.</div>
                    </div>

                    <div class="field">
                        <label>Server message contract</label>
                        <div class="muted" style="font-family:monospace;font-size:12px">[
                            { id, class, conf, bbox: [x, y, w, h] }
                        ]  where x,y,w,h are normalized (0..1) relative to video frame</div>
                    </div>
                </aside>
            </div>

            <footer>Tip: If you run a Python detector, have it send JSON via WebSocket to the URL above. Demo mode provides simulated boxes.</footer>
        </div>

        <script>
            // Elements
            const video = document.getElementById('video');
            const canvas = document.getElementById('overlay');
            const ctx = canvas.getContext('2d');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const serverUrlInput = document.getElementById('serverUrl');
            const modeSelect = document.getElementById('mode');
            const sendRateInput = document.getElementById('sendRate');

            let stream = null;
            let ws = null;
            let sendInterval = null;
            let lastSent = 0;
            let detections = []; // last received detections
            let running = false;

            function resizeCanvas(){
                canvas.width = video.videoWidth || video.clientWidth;
                canvas.height = video.videoHeight || video.clientHeight;
            }

            async function startCamera(){
                stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
                video.srcObject = stream;
                await video.play();
                resizeCanvas();
                window.addEventListener('resize', resizeCanvas);
            }

            function stopCamera(){
                if(stream){
                    stream.getTracks().forEach(t=>t.stop());
                    stream = null;
                }
                video.pause();
                window.removeEventListener('resize', resizeCanvas);
            }

            function connectWS(url){
                if(ws) ws.close();
                ws = new WebSocket(url);
                ws.binaryType = 'arraybuffer';
                ws.onopen = ()=>console.log('WS connected');
                ws.onmessage = (evt)=>{
                    try{
                        const data = JSON.parse(evt.data);
                        // expected: array of detections
                        detections = data;
                    }catch(e){console.warn('Invalid WS message', e);}
                };
                ws.onclose = ()=>console.log('WS closed');
                ws.onerror = (e)=>console.warn('WS error', e);
            }

            // Draw loop
            function draw(){
                if(!running) return;
                resizeCanvas();
                ctx.clearRect(0,0,canvas.width,canvas.height);

                // draw detections (bbox coords are normalized)
                detections.forEach(d=>{
                    const x = Math.round(d.bbox[0]*canvas.width);
                    const y = Math.round(d.bbox[1]*canvas.height);
                    const w = Math.round(d.bbox[2]*canvas.width);
                    const h = Math.round(d.bbox[3]*canvas.height);

                    // box
                    ctx.strokeStyle = 'rgba(88,214,141,0.95)';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(x,y,w,h);

                    // label
                    ctx.fillStyle = 'rgba(3,15,18,0.8)';
                    ctx.fillRect(x, y-22, Math.max(80, ctx.measureText(d.class+' '+(d.conf||'')).width+12), 22);
                    ctx.fillStyle = '#e6fff1';
                    ctx.font = '14px system-ui';
                    ctx.fillText(d.class+' '+(d.conf? (d.conf.toFixed(2)) : ''), x+6, y-6);

                    // overlay image if exists
                    const img = overlayCache[d.class];
                    if(img && img.complete){
                        // draw overlay above box
                        const ow = w;
                        const oh = Math.round(ow * img.height / img.width);
                        const oy = Math.max(0, y - oh - 6);
                        ctx.drawImage(img, x, oy, ow, oh);
                    }
                });

                requestAnimationFrame(draw);
            }

            // Send frames at configured rate (as JPEG blobs) to WS server
            async function startSender(){
                const fps = Math.max(1, parseInt(sendRateInput.value)||5);
                const delay = 1000 / fps;
                lastSent = 0;
                sendInterval = setInterval(async ()=>{
                    if(!ws || ws.readyState !== WebSocket.OPEN) return;
                    // capture smaller frame to reduce bandwidth
                    const w = 640;
                    const h = Math.round((video.videoHeight/video.videoWidth)*w) || 360;
                    const off = document.createElement('canvas'); off.width = w; off.height = h; const octx = off.getContext('2d');
                    octx.drawImage(video, 0, 0, w, h);
                    off.toBlob(b=>{ if(b) ws.send(b); }, 'image/jpeg', 0.6);
                }, delay);
            }

            function stopSender(){ if(sendInterval){ clearInterval(sendInterval); sendInterval = null; }}

            // overlay image cache
            const overlayCache = {};
            function loadOverlay(name){
                if(overlayCache[name]) return overlayCache[name];
                const img = new Image(); img.src = '/overlays/'+name+'.png'; overlayCache[name]=img; return img;
            }

            // demo generator
            function startDemo(){
                // create a few moving boxes
                let t0 = 0;
                const classes = ['person','dog','car'];
                setInterval(()=>{
                    const now = Date.now()/1000;
                    t0 = now;
                    const w = canvas.width; const h = canvas.height;
                    detections = classes.map((c,i)=>{
                        const bx = (0.1 + 0.2*i + 0.05*Math.sin(now+i))%0.8;
                        const by = (0.2 + 0.15*i + 0.07*Math.cos(now+i))%0.7;
                        const bw = 0.18; const bh = 0.25;
                        return { id: i, class: c, conf: 0.86 - i*0.1, bbox:[bx,by,bw,bh] };
                    });
                }, 200);
            }

            // wire controls
            startBtn.addEventListener('click', async ()=>{
                if(running) return; running = true;
                await startCamera();
                if(modeSelect.value === 'ws'){
                    connectWS(serverUrlInput.value);
                    startSender();
                } else {
                    startDemo();
                }
                // preload some overlay placeholders (optional)
                ['person','dog','car'].forEach(loadOverlay);
                draw();
            });

            stopBtn.addEventListener('click', ()=>{
                running = false;
                stopSender();
                if(ws){ ws.close(); ws=null; }
                stopCamera();
                detections = [];
                ctx.clearRect(0,0,canvas.width,canvas.height);
            });

            // expose loadOverlay for later
            window.loadOverlay = loadOverlay;
        </script>
    </body>
</html>